## T1 Maze

官方题解：

![QQ图片20241105113104](C:\Users\lenovo\Desktop\QQ图片20241105113104.png)

数位DP套路，先将答案差分一下，需要手动模拟二进制下 $L-1$ 的过程。

关键在于乘法对加法有分配率，因为还要向右走，相当于 $\times 2+1$ 的操作，因此仍需要记录方案数。

具体的，设 $dp_{i,j,0/1}$ 表示走到第 $i$ 位，改变了 $j$ 次定义，是否卡着上界的价值和。

$f_{i,j,0/1}$ 表示这样的个数。分类讨论：

- 当前这一步应该走 $r_i=0$ 向左走。
  - 不考虑上界：$dp_{i,j,0}=dp_{i-1,j}\times 2+dp_{i-1,j-1}\times 2+f_{i-1,j-1}$。
  - 考虑上界：
    - 这一步上界是 $0$：$dp_{i,j,1}=dp_{i-1,j,1}\times 2$。
    - 这一步上界是 $1$：$dp_{i,j,0}=dp_{i-1,j,1}\times 2,dp_{i,j,1}=dp_{i-1,j-1,1}\times2 +f_{i-1,j-1,1}$。

对于向右走同理，注意只可能由卡着上界变成不卡着上界，而不会由不卡着上界变成卡着上界。

需要特判 $j=0$，防止数组越界。



# T2 matrix

考虑特殊性质：$n=m=k$。

设 $b_i$ 表示第 $i$ 行整体加了多少，$c_j$ 表示第 $j$ 列整体加了多少。那么若合法，需要全部满足：
$$
a_{i,j}=b_i+c_j
$$
然后简单化简一下：
$$
a_{1,1}=b_1+c_1,a_{1,2}=b_{1}+c_2
\Longrightarrow  c_2-c_1=a_{1,2}-a_{1,1}
$$
可以推得 $a_{1,2}-a_{1,1}=a_{2,2}-a_{2,1}=a_{i,2}-a_{i,1}$。所以 $O(n^2)$ 即可用这个必要条件 check 是否合法。

进一步，本质实际上是**二分图**。可以证明这即是充要条件。

对于一般的情况，可以不断地消去一行/一列，转换成特殊性质。



# T3

正难则反，考虑一种颜色 $c$ 不对多少路径有贡献。

考虑把所有颜色 $c$ 的点拿出来，可以将树划分为若干个联通块，我们只需要统计出这些联通块的大小即可。用树状数组维护。





##  T4  别回头

> 给定无向图和起点终点，每次询问从起点出发走 $k$ 条边到达终点的方案数。
>
> 有限制：不能重复经过一条边连续两次。$n\le 200,k\le 10^9,q\le 200$。

如果没有限制的话是传递闭包矩阵乘法的经典例题，既然加入限制，那么首先想到的是增加维度。

设 $g_{t,y,x}$ 表示走了 $t$ 步，当前在 $y$，上一步在 $x$ 的方案数。那么有转移：
$$
g_{t,y,x}=\sum_{z\to x,z\ne y} g_{t-1,x,z}\tag1
$$
由此可以写出一个 $O(q n^6\log )$ 复杂度的暴力，但部分分是 $n=15$，这档部分分该如何不被卡常？

**注意到 $m\le \frac{n(n-1)}{2}$**，因此状态改为记录边，复杂度为 $O(qm^3\log)$，常数是前者的 $\frac{1}{10}$。

如何优化到 $O(qn^3\log)$？首先要做的就是**减少状态**。

设 $f_{t,y}$ 表示 $\sum g_{t,y,x}$，我们尝试能否写出转移。
$$
f_{t,y}=\sum_{x\to y} (f_{t-1,x}-g_{t-1,x,y})\tag2
$$
将 $(1)$ 代入 $(2)$，那么有：
$$
f_{t,y}=\sum_{x\to y}(f_{t-1,x}-\sum _{z\to y,z\ne x}g_{t-2,y,z})
\\
=\sum_{x\to y}f_{t-1,x}-(f_{t-2,y}-g_{t-2,y,x})
\\
=\sum f_{t-1,x} -deg_i\times f_{t-2,y}+f_{t-2,y}
\\
=\sum_{x\to y} f_{t-1,x} - (deg_i+1)f_{t-2,y}
$$
至此，我们将 $n^2$ 的状态优化为了 $2n$，发现这是经典的多次询问，查询矩阵快速幂。用经典的向量 trick 即可做到 $O(n^3\log +qn^2\log)$ 复杂度。

注意有细节，直接写过不了样例：起点上一步不确定。因此先暴力求出所有 $f_{1,x}$ 再开始转移。特判 $k\le 1$ 的情况。

很卡常，需要内层八位循环展开。

相似习题：[European Trip - 洛谷 | 计算机科学教育新生态 (luogu.com.cn)](https://www.luogu.com.cn/problem/CF1662C) 